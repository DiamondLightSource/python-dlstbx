from __future__ import annotations

import pathlib
import subprocess

from dlstbx.wrapper import Wrapper


class MetalIdWrapper(Wrapper):

    _logger_name = "dlstbx.wrap.metal_id"

    def run(self):
        assert hasattr(self, "recwrap"), "No recipewrapper object found"
        self.log.debug(
            f"Running recipewrap file {self.recwrap.recipe_step['parameters']['recipewrapper']}"
        )
        # Get parameters from the recipe file
        dimple_dir_above = pathlib.Path(
            self.recwrap.recipe_step["job_parameters"]["dimple_dir_above"]
        )
        dimple_dir_below = pathlib.Path(
            self.recwrap.recipe_step["job_parameters"]["dimple_dir_below"]
        )
        pdb_directory = pathlib.Path(
            self.recwrap.recipe_step["job_parameters"]["user_pdb_directory"]
        )
        pdb = pdb_directory / self.recwrap.recipe_step["job_parameters"]["pdb"]

        # Make a temporary directory for the data to be saved into
        working_directory = pathlib.Path(
            self.recwrap.recipe_step["job_parameters"]["working_directory"]
        )
        working_directory.mkdir(parents=True, exist_ok=True)

        results_directory = pathlib.Path(
            self.recwrap.recipe_step["job_parameters"]["results_directory"]
        )
        results_directory.mkdir(parents=True, exist_ok=True)

        print("Making double difference map")
        pha_above = dimple_dir_above / "anode.pha"
        pha_below = dimple_dir_below / "anode.pha"
        coot_script = [
            "#!/usr/bin/env coot",
            "# python script for coot - generated by metal_ID",
            "set_nomenclature_errors_on_read('ignore')",
            f"read_pdb('{pdb}')",
            f"map_above = read_phs_and_make_map_using_cell_symm_from_previous_mol('{pha_above}')",
            f"map_below = read_phs_and_make_map_using_cell_symm_from_previous_mol('{pha_below}')",
            "map_diff = difference_map(map_above, map_below, 1)",
            f"""export_map(map_diff, "{working_directory/'diff.map'}")""",
            "coot_real_exit(0)",
        ]
        coot_path = working_directory / "coot_diff_map.py"
        with open(coot_path, "w") as script_file:
            for line in coot_script:
                script_file.write(line + "\n")
        print("Written coot script")
        coot_command = f"coot --no-guano --no-graphics -s {coot_path}"
        print(coot_command)
        result = subprocess.run(
            coot_command, shell=True, capture_output=True, text=True
        )
        with open(working_directory / "metal_id.log", "w") as log_file:
            log_file.write(result.stdout)

        print("Script finished")
        return True
