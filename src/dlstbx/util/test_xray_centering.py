import dlstbx.util.xray_centering


def test_xray_centering():
    # fmt: off
    data = [(2, 73), (1, 0), (4, 119), (3, 187), (5, 2), (6, 0), (8, 0), (7, 0), (9, 0), (10, 0), (11, 0), (12, 0), (13, 0), (14, 0), (15, 0), (16, 0), (17, 0), (18, 0), (19, 0), (20, 0), (21, 0), (22, 0), (23, 144), (24, 449), (25, 539), (26, 418), (27, 141), (28, 2), (29, 0), (30, 100), (31, 402), (32, 592), (33, 538), (34, 394), (35, 221), (36, 0), (37, 0), (38, 0), (39, 0), (40, 0), (41, 0), (42, 0), (43, 0), (44, 0), (45, 0), (46, 0), (47, 0), (48, 0), (49, 151), (50, 352), (51, 440), (52, 506), (53, 515), (54, 229), (55, 13), (56, 0), (58, 2), (57, 0), (59, 27), (60, 229), (61, 415), (62, 481), (64, 389), (65, 90), (63, 387), (67, 0), (66, 1), (68, 0), (69, 0), (70, 0), (71, 0), (72, 0), (73, 0), (74, 0), (77, 436), (76, 441), (78, 385), (79, 289), (80, 96), (75, 107), (81, 74), (82, 18), (83, 0), (84, 0), (85, 0), (86, 0), (87, 0), (88, 25), (89, 26), (90, 41), (91, 179), (92, 376), (93, 382), (94, 295), (95, 28), (96, 0), (97, 0), (98, 0), (99, 0), (100, 0), (101, 14), (102, 115), (103, 217), (104, 159), (105, 52), (106, 29), (107, 44), (109, 0), (108, 9), (110, 0), (111, 0), (112, 0), (113, 0), (114, 0), (115, 0), (116, 0), (117, 0), (118, 11), (119, 57), (120, 24), (121, 22), (122, 16), (123, 32), (124, 41), (125, 11), (126, 0), (127, 26), (128, 48), (129, 27), (130, 24), (131, 16), (132, 8), (134, 0), (133, 2), (135, 0), (136, 0), (137, 0), (138, 0), (139, 0), (140, 0), (141, 0), (143, 0), (142, 0), (144, 0), (145, 0), (146, 0), (147, 0), (148, 0), (149, 0), (150, 0), (151, 0), (152, 10), (153, 28), (154, 48)]
    # fmt: on
    results, stdout = dlstbx.util.xray_centering.main(data)
    print(stdout)

    assert "There are 592 reflections in image no 32." in stdout
    assert (
        "[ - ,  - , 402, 592, 538, 394,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ]"
        in stdout
    )
    assert results == {
        "best_image": 32,
        "best_region": list(
            sorted(
                [
                    (1, 2),
                    (1, 3),
                    (1, 4),
                    (2, 2),
                    (2, 3),
                    (2, 4),
                    (2, 5),
                    (3, 3),
                    (3, 4),
                    (3, 5),
                    (3, 6),
                    (4, 4),
                    (4, 5),
                    (4, 6),
                    (4, 7),
                    (5, 6),
                    (5, 7),
                    (5, 8),
                    (6, 7),
                    (6, 8),
                ]
            )
        ),
        "boxSizeXPixels": 1.25,
        "boxSizeYPixels": 1.25,
        "centre_x": 403.0125,
        "centre_x_box": 5.45,
        "centre_y": 245.95,
        "centre_y_box": 3.8,
        "message": "ok",
        "numBoxesX": 14,
        "numBoxesY": 11,
        "reflections_in_best_image": 592,
        "status": "ok",
        "sum_x": 109.0,
        "sum_y": 76.0,
        "topLeft": (396.2, 241.2),
    }


def test_xray_centering_second_example():
    # fmt: off
    data = [(2, 0), (12, 0), (14, 0), (10, 0), (9, 0), (4, 0), (8, 0), (16, 0), (17, 0), (19, 0), (21, 0), (24, 0), (26, 0), (29, 0), (31, 0), (32, 0), (1, 0), (34, 0), (36, 0), (38, 0), (39, 0), (42, 0), (44, 0), (46, 0), (48, 0), (11, 0), (13, 0), (5, 0), (3, 0), (7, 0), (6, 0), (15, 0), (18, 0), (20, 0), (22, 0), (23, 0), (25, 0), (27, 0), (28, 0), (30, 0), (33, 0), (35, 0), (37, 0), (40, 0), (41, 0), (43, 0), (45, 0), (49, 0), (53, 0), (54, 0), (56, 0), (47, 0), (50, 0), (51, 0), (52, 0), (58, 0), (55, 0), (59, 0), (57, 0), (62, 0), (60, 0), (64, 0), (66, 0), (61, 0), (68, 0), (63, 0), (69, 0), (65, 0), (73, 0), (67, 0), (74, 0), (70, 0), (76, 0), (71, 0), (78, 0), (79, 0), (72, 0), (82, 1), (75, 0), (85, 0), (77, 0), (86, 1), (80, 0), (88, 0), (81, 0), (89, 0), (83, 0), (92, 0), (84, 1), (94, 0), (87, 0), (96, 0), (90, 0), (98, 0), (91, 0), (100, 0), (102, 0), (93, 0), (104, 0), (95, 0), (106, 0), (97, 0), (108, 0), (99, 0), (110, 0), (101, 0), (112, 0), (103, 0), (114, 0), (116, 0), (105, 0), (118, 0), (107, 0), (120, 0), (109, 0), (122, 0), (111, 0), (124, 0), (113, 0), (127, 0), (115, 0), (128, 1), (130, 2), (117, 0), (132, 3), (134, 2), (119, 0), (136, 0), (121, 0), (138, 0), (123, 0), (139, 0), (142, 0), (125, 0), (126, 0), (144, 0), (129, 2), (147, 0), (131, 2), (150, 0), (133, 3), (149, 0), (135, 2), (152, 0), (137, 0), (153, 1), (156, 9), (140, 0), (159, 7), (141, 0), (158, 11), (143, 0), (162, 4), (145, 0), (164, 0), (146, 0), (166, 0), (148, 0), (168, 0), (151, 0), (169, 0), (154, 3), (172, 0), (155, 5), (174, 0), (157, 4), (177, 0), (178, 0), (160, 7), (180, 0), (161, 2), (182, 0), (163, 1), (184, 0), (165, 0), (188, 0), (167, 0), (186, 0), (170, 0), (190, 0), (171, 0), (192, 0), (173, 0), (194, 0), (198, 0), (175, 0), (197, 0), (176, 0), (199, 0), (179, 0), (203, 6), (181, 0), (204, 7), (183, 0), (206, 9), (185, 0), (208, 3), (187, 0), (210, 2), (189, 0), (212, 0), (191, 0), (193, 0), (214, 0), (215, 0), (218, 0), (195, 0), (220, 0), (196, 0), (222, 1), (200, 8), (224, 3), (201, 5), (226, 6), (202, 9), (228, 7), (230, 9), (205, 7), (232, 9), (207, 6), (234, 3), (209, 1), (237, 0), (211, 0), (238, 0), (213, 0), (240, 0), (216, 0), (242, 0), (217, 0), (244, 0), (219, 0), (246, 0), (221, 0), (247, 0), (223, 1), (250, 0), (225, 4), (252, 0), (227, 6), (254, 0), (256, 0), (229, 10), (259, 0), (231, 8), (260, 0), (233, 6), (235, 0), (261, 0), (236, 0), (264, 0), (239, 0), (266, 0), (241, 0), (268, 0), (270, 0), (243, 0), (271, 0), (245, 0), (274, 9), (248, 0), (276, 7), (249, 0), (278, 10), (251, 0), (280, 10), (253, 0), (282, 2), (285, 0), (255, 0), (286, 0), (257, 0), (288, 0), (258, 0), (290, 0), (262, 0), (291, 0), (263, 0), (294, 2), (265, 0), (296, 5), (267, 0), (297, 5), (269, 0), (300, 9), (301, 11), (272, 3), (304, 7), (273, 8), (306, 5), (275, 9), (308, 0), (277, 9), (310, 0), (279, 11), (312, 0), (281, 6), (314, 0), (283, 2), (316, 0), (284, 1), (318, 0), (287, 0), (320, 0), (289, 0), (322, 0), (292, 0), (324, 0), (293, 0), (327, 0), (295, 3), (328, 0), (298, 11), (330, 0), (299, 10), (332, 0), (334, 0), (302, 8), (336, 0), (303, 8), (338, 0), (305, 9), (341, 0), (307, 0), (342, 0), (309, 0), (344, 3), (311, 0), (346, 12), (313, 0), (347, 7), (350, 8), (315, 0), (352, 8), (317, 0), (354, 3), (319, 0), (356, 0), (358, 0), (321, 0), (359, 0), (362, 0), (323, 0), (364, 0), (366, 0), (325, 0), (368, 2), (326, 0), (370, 9), (329, 0), (372, 9), (374, 6), (331, 0), (376, 8), (333, 0), (378, 4), (335, 0), (380, 0), (382, 0), (337, 0), (384, 0), (339, 0), (386, 0), (340, 0), (389, 0), (343, 0), (391, 0), (345, 12), (392, 0), (348, 9), (393, 0), (396, 0), (349, 7), (398, 0), (351, 14), (401, 0), (353, 6), (402, 0), (355, 2), (404, 0), (357, 0), (406, 0), (360, 0), (408, 0), (411, 0), (361, 0), (412, 0), (415, 2), (363, 0), (416, 4), (365, 0), (418, 4), (367, 0), (419, 6), (369, 7), (422, 5), (371, 12), (423, 10), (373, 8), (426, 0), (375, 10), (428, 0), (430, 0), (379, 0), (432, 0), (434, 0), (377, 9), (436, 0), (381, 0), (438, 0), (383, 0), (440, 0), (385, 0), (442, 3), (387, 0), (444, 8), (388, 0), (445, 7), (390, 0), (449, 7), (395, 0), (450, 5), (394, 0), (452, 0), (397, 0), (454, 0), (399, 0), (457, 0), (400, 0), (458, 0), (403, 0), (460, 0), (405, 0), (462, 0), (407, 0), (464, 0), (409, 0), (466, 0), (410, 0), (468, 0), (413, 0), (470, 0), (414, 0), (472, 0), (417, 8), (473, 0), (476, 0), (420, 7), (478, 0), (421, 11), (480, 0), (424, 4), (482, 0), (425, 2), (484, 0), (486, 0), (427, 0), (487, 0), (429, 0), (490, 8), (431, 0), (492, 6), (433, 0), (495, 0), (435, 0), (496, 0), (437, 0), (498, 0), (439, 0), (500, 0), (502, 0), (441, 1), (504, 0), (443, 6), (506, 0), (447, 8), (509, 0), (446, 7), (510, 0), (448, 6), (512, 0), (451, 0), (514, 0), (453, 0), (516, 0), (455, 0), (518, 5), (520, 7), (456, 0), (522, 3), (459, 0), (523, 2), (461, 0), (527, 0), (463, 0), (528, 0), (465, 0), (530, 0), (467, 0), (532, 0), (469, 0), (534, 0), (471, 0), (536, 0), (475, 0), (538, 0), (474, 0), (540, 0), (477, 0), (541, 0), (479, 0), (543, 0), (481, 0), (545, 0), (483, 0), (548, 0), (550, 0), (485, 0), (552, 0), (488, 4), (554, 0), (489, 6), (556, 0), (491, 6), (559, 1), (493, 4), (561, 2), (494, 3), (562, 2), (497, 0), (564, 0), (499, 0), (565, 0), (501, 0), (569, 0), (503, 0), (572, 0), (574, 0), (505, 0), (570, 0), (507, 0), (575, 0), (508, 0), (578, 0), (511, 0), (580, 0), (513, 0), (582, 0), (515, 0), (584, 0), (517, 0), (586, 0), (519, 4), (587, 0), (592, 1), (521, 7), (593, 2), (525, 0), (594, 1), (524, 0), (596, 0), (526, 0), (598, 0), (529, 0), (600, 0), (531, 0), (602, 0), (533, 0), (604, 0), (535, 0), (607, 0), (608, 0), (537, 0), (610, 0), (539, 0), (613, 0), (542, 0), (614, 0), (544, 0), (616, 0), (546, 0), (618, 0), (547, 0), (620, 0), (549, 0), (622, 0), (551, 0), (623, 0), (553, 0), (627, 0), (628, 0), (555, 0), (630, 0), (557, 0), (631, 0), (558, 0), (634, 0), (560, 3), (636, 0), (638, 0), (640, 0), (563, 2), (566, 0), (567, 0), (568, 0), (642, 0), (644, 0), (646, 0), (648, 0), (571, 0), (650, 0), (573, 0), (651, 0), (577, 0), (653, 0), (576, 0), (656, 0), (579, 0), (658, 0), (581, 0), (660, 0), (583, 0), (661, 0), (585, 0), (664, 0), (588, 0), (666, 0), (589, 0), (668, 0), (591, 0), (670, 0), (590, 0), (671, 0), (595, 1), (674, 0), (676, 0), (597, 0), (678, 0), (599, 0), (680, 0), (601, 0), (682, 0), (603, 0), (684, 0), (605, 0), (686, 0), (606, 0), (688, 0), (609, 0), (690, 0), (612, 0), (692, 0), (694, 0), (611, 0), (696, 0), (617, 0), (698, 0), (615, 0), (700, 0), (619, 0), (702, 0), (621, 0), (704, 0), (624, 0), (706, 0), (625, 0), (708, 0), (626, 0), (709, 0), (629, 0), (712, 0), (632, 0), (714, 0), (633, 0), (716, 0), (635, 0), (719, 0), (637, 0), (720, 0), (722, 0), (639, 0), (723, 0), (641, 0), (726, 0), (643, 0), (728, 0), (645, 0), (732, 0), (647, 0), (731, 0), (649, 0), (735, 0), (652, 0), (736, 0), (654, 0), (738, 0), (655, 0), (740, 0), (741, 0), (657, 0), (743, 0), (659, 0), (746, 0), (662, 0), (749, 0), (663, 0), (748, 0), (665, 0), (752, 0), (667, 0), (754, 0), (669, 0), (756, 0), (672, 0), (759, 0), (673, 0), (760, 0), (762, 0), (675, 0), (764, 0), (677, 0), (766, 0), (679, 0), (768, 0), (683, 0), (770, 0), (681, 0), (772, 0), (685, 0), (774, 0), (687, 0), (776, 0), (689, 0), (778, 0), (691, 0), (780, 0), (693, 0), (782, 0), (695, 0), (784, 0), (786, 0), (697, 0), (787, 0), (699, 0), (790, 0), (701, 0), (792, 0), (703, 0), (794, 0), (705, 0), (795, 0), (707, 0), (798, 0), (710, 0), (799, 0), (711, 0), (802, 0), (713, 0), (804, 0), (806, 0), (715, 0), (808, 0), (717, 0), (810, 0), (718, 0), (812, 0), (814, 0), (721, 0), (815, 0), (724, 0), (818, 0), (725, 0), (821, 0), (727, 0), (822, 0), (729, 0), (824, 0), (826, 0), (730, 0), (828, 0), (733, 0), (734, 0), (737, 0), (739, 0), (742, 0), (744, 0), (745, 0), (747, 0), (750, 0), (751, 0), (753, 0), (755, 0), (757, 0), (758, 0), (761, 0), (763, 0), (765, 0), (767, 0), (769, 0), (771, 0), (773, 0), (775, 0), (777, 0), (779, 0), (781, 0), (783, 0), (785, 0), (788, 0), (789, 0), (791, 0), (793, 0), (796, 0), (797, 0), (801, 0), (800, 0), (803, 0), (805, 0), (807, 0), (809, 0), (811, 0), (813, 0), (817, 0), (816, 0), (819, 0), (820, 0), (823, 0), (825, 0), (827, 0)]
    # fmt: on

    results, stdout = dlstbx.util.xray_centering.main(
        data=data,
        numBoxesX=36.0,
        numBoxesY=23.0,
        snaked=True,
        boxSizeXPixels=17.6678445229682,
        boxSizeYPixels=17.6678445229682,
        topLeft=(339.919, 182.59),
        orientation="horizontal",
    )
    print(stdout)

    assert "There are 14 reflections in image no 351." in stdout
    assert (
        "[ - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,   7,   9,  12,   9,   8,  - ,  10,   8,   9,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ,  - ]"
        in stdout
    )
    # fmt: off
    best_region = list(sorted([(4, 13), (4, 14), (4, 15), (5, 12), (5, 14), (5, 16), (6, 11), (6, 12), (6, 13), (6, 14), (6, 15), (7, 10), (7, 11), (7, 12), (7, 13), (7, 14), (7, 15), (8, 9), (8, 10), (8, 11), (8, 12), (8, 13), (8, 14), (8, 15), (8, 16), (9, 8), (9, 9), (9, 10), (9, 11), (9, 12), (9, 13), (9, 14), (9, 15), (10, 8), (10, 9), (10, 10), (10, 11), (10, 12), (10, 14), (10, 15), (10, 16), (11, 9), (11, 11), (11, 12), (11, 15), (12, 11), (12, 12), (12, 13), (12, 14), (12, 16), (13, 14), (14, 15), (14, 16), (4, 11), (5, 10), (5, 11), (7, 8), (7, 9)]))
    # fmt: on

    assert results == {
        "best_image": 351,
        "best_region": best_region,
        "boxSizeXPixels": 17.6678445229682,
        "boxSizeYPixels": 17.6678445229682,
        "centre_x": 567.4686527354697,
        "centre_x_box": 12.879310344827585,
        "centre_y": 340.0775106616303,
        "centre_y_box": 8.913793103448276,
        "message": "ok",
        "numBoxesX": 36,
        "numBoxesY": 23,
        "reflections_in_best_image": 14,
        "status": "ok",
        "sum_x": 747.0,
        "sum_y": 517.0,
        "topLeft": (339.919, 182.59),
    }
